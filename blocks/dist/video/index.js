(()=>{"use strict";const e=window.wp.blocks,a=JSON.parse('{"name":"vimeify/video"}'),o=window.wp.element,t=window.wp.blockEditor,l=window.wp.components,r=window.wp.data,n=window.WPVimeoVideos?window.WPVimeoVideos:null,{name:i}=a;(0,e.registerBlockType)(i,{attributes:{currentValue:{type:"string"}},edit:({attributes:e,setAttributes:a})=>{const i=window.VimeifyUploadBlock&&window.VimeifyUploadBlock.i18n?window.VimeifyUploadBlock.i18n:{},s=window.VimeifyUploadBlock&&window.VimeifyUploadBlock.notifyEndpoint?window.VimeifyUploadBlock.notifyEndpoint:"",c=window.VimeifyUploadBlock.methods?window.VimeifyUploadBlock.methods:{},d=window.VimeifyUploadBlock.nonce?window.VimeifyUploadBlock.nonce:"",u=window.VimeifyUploadBlock.restBase?window.VimeifyUploadBlock.restBase:"",m=window.VimeifyUploadBlock.accessToken?window.VimeifyUploadBlock.accessToken:"",p=window.VimeifyUploadBlock.upload_form_options.enable_view_privacy?1:0,w=p?(e=>{const a={};for(let o in e)e[o].available&&(a[o]=e[o]);return a})(window.VimeifyUploadBlock.upload_form_options.privacy_view):[],f=Object.keys(w).find((e=>!0===w[e].default)),v=window.VimeifyUploadBlock.upload_form_options.enable_folders?1:0,h=window.VimeifyUploadBlock.upload_form_options.default_folder,y=(0,t.useBlockProps)(),E={label:"Select result...",value:""},[g,V]=(0,o.useState)(""),[_,b]=(0,o.useState)(""),[k,S]=(0,o.useState)(""),[B,C]=(0,o.useState)(null),[U,T]=(0,o.useState)(null),[N,P]=(0,o.useState)(f),[x,O]=(0,o.useState)(h.uri),[F,j]=(0,o.useState)(!1),[W,J]=(0,o.useState)(0),[q,A]=(0,o.useState)(""),[I,z]=(0,o.useState)([]),[D,R]=(0,o.useState)(""),[G,H]=(0,o.useState)([]),[K,L]=(0,o.useState)(""),[M,Q]=(0,o.useState)([]),{savePost:X}=(0,r.useDispatch)("core/editor");return(0,o.useEffect)((()=>{const e=setTimeout((()=>{D.length>2&&new n.Profile(m).search({page:1,per_page:100,query:D,sort:"date",direction:"desc",onSuccess:function(e){e.data.length>0&&H(e.data)},onError:function(e){console.warn("Vimeify: Unable to search remote profile."),console.warn(e),alert("Search error: "+e.message)}})}),800);return()=>clearTimeout(e)}),[D]),(0,o.useEffect)((()=>{const e=setTimeout((async()=>{if(K.length>2)try{const e=await fetch(u+"vimeify/v1/videos?s="+K+"&_wpnonce="+d),a=await e.json();Q(a?.data)}catch(e){console.warn("Error searching local videos:"),console.warn(e),alert("Search error: "+e.message)}}),800);return()=>clearTimeout(e)}),[K]),(0,o.useEffect)((()=>{const e=setTimeout((async()=>{if(q.length>2)try{const e=await fetch(u+"vimeify/v1/folders?query="+q+"&_wpnonce="+d),a=await e.json();z([h].concat(a?.data?a?.data:[]))}catch(e){console.warn("Error searching folders:"),console.warn(e),alert("Search error: "+e.message)}}),800);return()=>clearTimeout(e)}),[q]),(0,o.createElement)("div",{...y},(0,o.createElement)("div",{className:e.currentValue?"vimeify-upload-form":""},e.currentValue&&""!==e.currentValue&&(0,o.createElement)("div",null,(0,o.createElement)("iframe",{width:"auto",height:"400",src:"https://player.vimeo.com/video/"+e.currentValue.replace("/videos/",""),frameBorder:"0",allow:"autoplay; encrypted-media",webkitallowfullscreen:!0,mozallowfullscreen:!0,allowFullScreen:!0}),(0,o.createElement)("hr",null),(0,o.createElement)("div",{style:{textAlign:"center"}},(0,o.createElement)(l.Button,{onClick:e=>{V(""),a({currentValue:""})},variant:"secondary"},i.words.clear))),e.currentValue&&""!==e.currentValue?"":(0,o.createElement)(o.Fragment,null,(0,o.createElement)("h3",{className:"vimeify-block-title"},"Vimeo"),(0,o.createElement)("div",{style:{marginBottom:"15px"}},(0,o.createElement)(l.RadioControl,{label:i.words.radio_title,selected:g,options:[{label:c.upload,value:"upload"},{label:c.local,value:"local"},{label:c.search,value:"search"}],onChange:e=>V(e)})),"upload"===g&&(0,o.createElement)("div",{className:"vimeify-upload-form-inner"},(0,o.createElement)(l.TextControl,{label:i.words.title,value:_,onChange:e=>b(e)}),(0,o.createElement)(l.TextareaControl,{label:i.words.description,value:k,onChange:e=>S(e)}),1===parseInt(p)&&(0,o.createElement)(l.SelectControl,{label:i.words.view_privacy,help:i.phrases.view_privacy_help,value:N,options:Object.keys(w).map((e=>({label:w[e].name,value:e}))),onChange:e=>P(e)}),1===parseInt(v)&&(0,o.createElement)("div",null,(0,o.createElement)(l.TextControl,{label:i.words.folder,placeholder:i.phrases.folder_placeholder,value:q,help:0===I.length?i.phrases.folder_help:"",onChange:e=>A(e)}),I.length>0&&(0,o.createElement)(l.SelectControl,{help:i.phrases.folder_help,value:x,options:I.map((e=>({label:e.name,value:e.uri}))),onChange:e=>O(e)})),B&&(0,o.createElement)("p",null,"Selected: ",B.name),(0,o.createElement)(l.FormFileUpload,{accept:"video/*",variant:"secondary",onChange:e=>C(e.currentTarget.files[0])},B?i.words.video_replace:i.words.video_select),F&&(0,o.createElement)("div",{className:"vimeify-progress"},(0,o.createElement)("div",{className:"vimeify-progress-value",style:{width:W+"%"}})),B&&(0,o.createElement)("div",{style:{marginTop:"10px"}},(0,o.createElement)(l.Button,{onClick:e=>{if(!n.Uploader.validateVideo(B))return alert(i.words.sorry+": "+i.phrases.upload_invalid_file,"error"),!1;new n.Uploader(m,B,{title:_,description:k,privacy:N,folder:x,wp:{notify_endpoint:s},beforeStart:function(){j(!0),J(.25)},onProgress:function(e,a){J((e/a*100).toFixed(2))},onSuccess:function(e,o){V(""),a({currentValue:o.uri}),X()},onError:function(e){j(!1),alert("Vimeo upload error.")},onVideoCreateError:function(e){let a="";const o=JSON.parse(e);a=o.hasOwnProperty("invalid_parameters")?o.invalid_parameters[0].developer_message:o.developer_message,j(!1),alert(a)},onWPNotifyError:function(e){let a="";const o=JSON.parse(e);a=o.hasOwnProperty("data")?o.data:"Error notifying WordPress about the file upload.",j(target,!0),alert(a)}}).start()},variant:"primary"},i.words.upload))),"search"===g&&(0,o.createElement)("div",{className:"vimeify-remote-search-form"},(0,o.createElement)(l.TextControl,{label:i.phrases.remote_search_placeholder,value:D,onChange:e=>R(e)}),G.length>0&&(0,o.createElement)(l.SelectControl,{label:i.words.video_list,value:U,options:[E].concat(G.map((e=>({label:e.name,value:e.uri})))),onChange:e=>T(e)}),U&&(0,o.createElement)(l.Button,{onClick:e=>{V(""),a({currentValue:U})},variant:"primary"},i.words.save)),"local"===g&&(0,o.createElement)("div",{className:"vimeify-local-search-form"},(0,o.createElement)(l.TextControl,{label:i.phrases.local_search_placeholder,value:K,onChange:e=>L(e)}),M.length>0&&(0,o.createElement)(l.SelectControl,{label:i.words.video_list,value:U,options:[E].concat(M.map((e=>({label:e.name,value:e.uri})))),onChange:e=>T(e)}),U&&(0,o.createElement)(l.Button,{onClick:e=>{V(""),a({currentValue:U})},variant:"primary"},i.words.save)))))},save:()=>null})})();